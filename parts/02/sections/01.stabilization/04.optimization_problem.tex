%-------------------------------------------------------------------------------
\subsection{The optimization problem}

At a generic time $t_k$, agent $i$ solves the following optimization problem:

\begin{align}
  \min\limits_{\overline{\vect{u}}_i (\cdot)}\ &
    J_i \big(\overline{\vect{u}}_i (\cdot);\ \vect{e}_i(t_k)\big) \triangleq
      \int_{t_k}^{t_k + T_p} F_i \big(\overline{\vect{e}}_i(s), \overline{\vect{u}}_i (s)\big) ds +
      V_i \big(\overline{\vect{e}}_i (t_k + T_p)\big) \label{position_based_cost} \\
  \text{subject to:} & \nonumber \\
                     & \dot{\overline{\vect{e}}}_i(s) = g_i \big(\overline{\vect{e}}_i (s), \overline{\vect{u}}_i (s)\big) \label{eq:internal_error_model} \\
  & \overline{\vect{e}}_i (t_k) = \vect{e}_i (t_k) \\
  & \overline{\vect{u}}_i(s) \in \mathcal{U}_i, s \in [t_k, t_k + T_p)\\
  & \overline{\vect{e}}_i (s) \in \mathcal{E}_i,\ s \in [t_k, t_k + T_p]\\
  & \overline{\vect{e}}_i (t_k + T_p) \in \mathcal{E}_{i,f} \subseteq \mathcal{E}_i
\end{align}

The notation $\overline{\cdot}$ is used to distinguish predicted states which
are internal to the controller, as opposed to their actual values. This means
that $\overline{\vect{e}}_i(\cdot)$ is the solution to
\eqref{eq:internal_error_model} driven by the control input
$\vect{u}_i^{\star}(\cdot) : [t_k, t_k + T_p] \to \mathcal{U}_i$ with
initial condition $\vect{e}_i(t_k)$.

The functions
$F_i : \mathcal{E}_i \times \mathcal{U}_i \to \mathbb{R}_{\geq 0}$ and
$V_i: \mathcal{E}_{i,f} \to \mathbb{R}_{\geq 0}$ are defined as
\begin{align}
  F_i (\vect{e}_i, \vect{u}_i)
  &\triangleq \vect{e}_i^{\top} \mat{Q}_i \vect{e}_i + \vect{u}_i^{\top} \mat{R}_i \vect{u}_i\\
  V_i (\vect{e}_i) & \triangleq \vect{e}_i^{\top} \mat{P}_i \vect{e}_i
\end{align}\\
Matrices $\mat{R}_i \in \mathbb{R}^{6 \times 6}$ are symmetric and positive
definite, while matrices $\mat{Q}_i, \mat{P}_i \in \mathbb{R}^{12 \times 12}$
are symmetric and positive semi-definite. Before defining the terminal set
$\mathcal{E}_{i,f}$ it is necessary to state the definition of a positively
invariant set:

\begin{bw_box}
  \begin{definition} (\textit{Positively Invariant Set})

    Consider a dynamical system $\dot{\vect{x}} = f(\vect{x})$,
    $\vect{x} \in \mathbb{R}^n$, and a trajectory $\vect{x}(t;\ \vect{x}_0)$,
    where $vect{x}_0$ is the initial condition. The set
    $S = \{\vect{x} \in \mathbb{R}^n : \gamma(\vect{x}) = 0\}$, where
    $\gamma$ is a valued function, is said to be \textit{positively invariant}
    if the following holds:
    \begin{align}
      \vect{x}_0 \in S \Rightarrow \vect{x}(t;\ \vect{x}_0) \in S,\ \forall t \geq t_0
    \end{align}

    Intuitively, this means that the set $S$ is positively invariant if a
    trajectory of the system does not exit it once it enters it.
    \label{def:positively_invariant}
  \end{definition}
\end{bw_box}

The terminal set $\mathcal{E}_{i,f} \subseteq \mathcal{E}_i$ is an admissible
positively invariant set for system \eqref{eq:position_based_error_model}
such that
\begin{align}
  \mathcal{E}_{i,f} = \{\vect{e}_i \in \mathcal{E}_i : \|\vect{e}_i\| \leq \varepsilon_0 \}
\end{align}
where $\varepsilon_0$ is an arbitrarily small but fixed positive real scalar.\\

With regard to the terminal penalty function $V_i$, the following lemma will
prove to be useful in guaranteeing the convergence of the solution to the
optimal control problem to the terminal region $\mathcal{E}_{i,f}$:

\begin{bw_box}
\begin{lemma} ($V_i$ is Lipschitz continuous in $\mathcal{E}_{i,f}$)

  The terminal penalty function $V_i$ is Lipschitz continuous in
  $\mathcal{E}_{i,f}$
  $$|V(\vect{e}_{1,i}) - V(\vect{e}_{2,i})| \leq L_{V_i} \|\vect{e}_{1,i} - \vect{e}_{2,i}\|$$
  where $\vect{e}_{1,i}, \vect{e}_{2,i} \in \mathcal{E}_{i,f}$,
  with Lipschitz constant $L_{V_i} = 2 \varepsilon_0 \lambda_{max}(P_i)$\\

  %\begin{gg_box}
  \textbf{Proof} For every $\vect{e}_i \in \mathcal{E}_{i,f}$, it holds that
  \begin{align}
    |V(\vect{e}_{1,i}) - V(\vect{e}_{2,i})| &= |\vect{e}_{1,i}^{\top} \mat{P}_i \vect{e}_{1,i} - \vect{e}_{2,i}^{\top} \mat{P}_i \vect{e}_{2,i}| \\
      &= |\vect{e}_{1,i}^{\top} \mat{P}_i \vect{e}_{1,i} - \vect{e}_{2,i}^{\top} \mat{P}_i \vect{e}_{2,i} \pm \vect{e}_{1,i}^{\top} \mat{P}_i \vect{e}_{2,i}| \\
      &= |\vect{e}_{1,i}^{\top} \mat{P}_i (\vect{e}_{1,i}-\vect{e}_{2,i}) - \vect{e}_{2,i}^{\top} \mat{P}_i (\vect{e}_{1,i}-\vect{e}_{2,i})| \\
      &\leq |\vect{e}_{1,i}^{\top} \mat{P}_i (\vect{e}_{1,i}-\vect{e}_{2,i})| + |\vect{e}_{2,i}^{\top} \mat{P}_i (\vect{e}_{1,i}-\vect{e}_{2,i})|
  \end{align}

  But for any $\vect{x}, \vect{y} \in \mathbb{R}^n$
  $$|\vect{x}^{\top} \mat{A} \vect{y}| \leq \lambda_{max}(A) \|\vect{x}\| \|\vect{y}\|$$
  where $\lambda_{max}(A)$ denotes the largest eigenvalue of matrix $\mat{A}$.
  Hence:
  \begin{align}
    |V(\vect{e}_{1,i}) - V(\vect{e}_{2,i})| &\leq
    \lambda_{max}(\mat{P}_i) \|\vect{e}_{1,i}\| \|\vect{e}_{1,i} - \vect{e}_{2,i}\| +
    \lambda_{max}(\mat{P}_i) \|\vect{e}_{2,i}\| \|\vect{e}_{1,i} - \vect{e}_{2,i}\| \\
    &= \lambda_{max}(\mat{P}_i) (\|\vect{e}_{1,i}\| + \|\vect{e}_{2,i}\|)\|\vect{e}_{1,i} - \vect{e}_{2,i}\| \\
    & \leq \lambda_{max}(\mat{P}_i) (\varepsilon_0 + \varepsilon_0)\|\vect{e}_{1,i} - \vect{e}_{2,i}\| \\
    &= 2 \varepsilon_0 \lambda_{max}(\mat{P}_i) \|\vect{e}_{1,i} - \vect{e}_{2,i}\|
  \end{align}
  \qedsymbol
  %\end{gg_box}
\label{lemma:V_Lipschitz_e_0}
\end{lemma}
\end{bw_box}


The solution to the optimal control problem \eqref{position_based_cost}
at time $t_k$ is an optimal control input
$\vect{u}_i^{\star}(\cdot;\ \vect{e}_i(t_k))$ which
is applied to the open-loop system until the next sampling instant $t_k + h$,
at which time a new optimal control problem is solved in the same manner:
\begin{align}
  \vect{u}_i\big(t;\ \vect{e}_i(t_k)\big) = \vect{u}_i^{\star}\big(t;\ \vect{e}_i(t_k)\big) \label{eq:position_based_optimal_u} \\
  t \in [t_k, t_k + h) \nonumber \\
  0 < h < T_p \nonumber
\end{align}

The control input $\vect{u}_i(\cdot)$ is a feedback, since it is
recalculated at each sampling instant based on the then-current state. The
solution to equation \eqref{eq:position_based_error_model}, starting at time
$t_k$, from an initial condition $\vect{e}_i(t_k)$, by application of the
control input $\vect{u}_i : [t_k, t_{k+1}] \to \mathcal{U}_i$ is denoted by
$$\vect{e}_i\big(t;\ \vect{u}_i(\cdot), \vect{e}_i(t_k)\big)$$
with $t \in [t_k, t_{k+1}]$.

The \textit{predicted} state of the system \eqref{eq:position_based_error_model}
at time $t_k + \tau$, based on the measurement of the state at time
$t_k$, $\vect{e}_i(t_k)$, by application of the control input
$\vect{u}_i\big(t;\ \vect{e}_i(t_k)\big)$, for the time period $t \in [t_k, t_{k+1}]$
is denoted by

\begin{align}
  \overline{\vect{e}}_i\big(t_k + \tau;\ \vect{u}_i(\cdot), \vect{e}_i(t_k)\big) \label{eq:position_based_predicted_error_0}
\end{align}
As is natural
\begin{align}
  \vect{e}_i(t_k) = \overline{\vect{e}}_i\big(t_k;\ \vect{u}_i(\cdot), \vect{e}_i(t_k)\big)
  \label{eq:error_now_to_predicted_error}
\end{align}

We can now give the definition of an \textit{admissible input}:

\begin{bw_box}
\begin{definition} (Admissible input)\\

  A control input $\vect{u}_i : [t_k, t_k + T_p] \to \mathbb{R}^6$ for a state
  $\vect{e}_i(t_k)$ is called \textit{admissible} if all the following hold:

  \begin{enumerate}
    \item $\vect{u}_i(\cdot)$ is piecewise continuous
    \item $\vect{u}_i(\tau) \in \mathcal{U}_i,\ \forall \tau \in [t_k, t_k + T_p]$
    \item $\vect{e}_i\big(\tau;\ \vect{u}_i(\cdot), \vect{e}_i(t_k)\big) \in \mathcal{E}_i,\ \forall \tau \in [t_k, t_k + T_p]$
    \item $\vect{e}_i\big(t_k + T_p;\ \vect{u}_i(\cdot), \vect{e}_i(t_k)\big) \in \mathcal{E}_{i,f}$
  \end{enumerate}

\end{definition}
\end{bw_box}
