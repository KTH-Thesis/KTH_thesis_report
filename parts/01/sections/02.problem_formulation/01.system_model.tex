%-------------------------------------------------------------------------------
\subsection{System Model}

Consider a set of $N$ rigid bodies, with $\mathcal{V} = \{ 1,2, \ldots, N\}$,
$N  \geq 2$, operating in a workspace $W\subseteq \mathbb{R}^3$.
A coordinate frame $\{i\}, i\in\mathcal{V}$ is attached to each body's
center of mass. The workspace is assumed to be modeled as a
bounded sphere $\mathcal{B}(\vect{p}_W,r_W)$ expressed in an inertial frame
$\{\mathcal{O}\}$.

We consider that over time $t$ each agent $i$ occupies the space of a sphere
$\mathcal{B}(\vect{p}_i(t), r_i)$, where $\vect{p}_i : \mathbb{R}_{\geq 0} \to \mathbb{R}^3$
is the position of the agent's center of mass, and $r_i < r_W$ is the radius of the
agent's body. We denote $\vect{q}_i(t):\mathbb{R}_{\geq 0} \to \mathbb{T}^3, i\in\mathcal{V}$,
the Euler angles representing the agents' orientation with respect to the
inertial frame $\{\mathcal{O}\}$,
with $\vect{q}_i \triangleq [\phi_i,\theta_i,\psi_i]^{\top}$, where
$\phi_i, \psi_i \in [-\pi, \pi]$ and
$\theta_i \in [-\frac{\pi}{2}, \frac{\pi}{2}]$. We define
$$\vect{x}_i \triangleq [\vect{p}^{\top}_i,\vect{q}^{\top}_i]^{\top},
\vect{x}_i:\mathbb{R}_{\geq 0} \to \mathbb{R}^3\times \mathbb{T}^3 \equiv \mathbb{M}$$
$$\vect{v}_i \triangleq [\dot{\vect{p}}^{\top}_i, \vect{\omega}^{\top}_i]^{\top},
\vect{v}_i : \mathbb{R}_{\geq 0} \to \mathbb{R}^3\times \mathbb{R}^3 \equiv \mathbb{R}^6$$
and model the motion of agent $i$ under second order dynamics:

\begin{subequations}
	\begin{align}
    \dot{\vect{x}}_i(t) &= \mat{J}_i^{-1}(\vect{x}_i) \vect{v}_i(t), \label{eq:system_1} \\
    \vect{u}_i &= \mat{M}_i(\vect{x}_i) \dot{\vect{v}}_i(t) + \mat{C}_i(\vect{x}_i,\dot{\vect{x}}_i) \vect{v}_i(t)+\vect{g}_i(\vect{x}_i), \label{eq:system_2}
	\end{align}
  \label{eq:system}
\end{subequations}

In equation \eqref{eq:system_1}, $\mat{J}_i:\mathbb{T}^3 \to \mathbb{R}^{6\times6}$ is
a Jacobian matrix that maps the non-orthogonal Euler angle rates to the
orthogonal angular velocities $\vect{v}_i$:

\begin{equation}
  \mat{J}_i(\vect{x}_i) =
  \begin{bmatrix}
    \mat{I}_3 & \mat{0}_{3 \times 3} \\
    \mat{0}_{3 \times 3} & \mat{J}_{ q }(\vect{x}_i) \\
  \end{bmatrix} \notag, \text{ with }
  \mat{J}_q(\vect{x}_i) =
  \begin{bmatrix}
    1 & 0 & -\sin\theta_i \\
    0 & \cos\phi_i & \cos\theta_i \sin\phi_i \\
    0 & - \sin\phi_i & \cos\phi_i \cos\theta_i
  \end{bmatrix} \notag
\end{equation}

The matrix $\mat{J}_i$ is singular when $det(\mat{J}_i)$ $=$ $\cos\theta_i = 0$
$\Leftrightarrow$ $\theta_i$ $=$ $\pm \frac{\pi}{2}$. The control scheme
proposed in this thesis guarantees that this is always avoided, and hence
equation \eqref{eq:system_1} is well defined. This gives rise to the following
remark:

\begin{bw_box}
  \begin{remark}
    $det(\mat{J}_i) = \cos\theta_i \leq 1$, $\forall i \in \mathcal{V}$
  \end{remark}
\end{bw_box}



In equation \eqref{eq:system_2}, $\mat{M}_i:\mathbb{M} \to \mathbb{R}^{6\times6}$ is
the symmetric and positive definite \textit{inertia matrix},
$\mat{C}_i:\mathbb{M}\times\mathbb{R}^6 \to \mathbb{R}^{6\times6}$ is the
\textit{Coriolis matrix} and $\vect{g}_i:\mathbb{M} \to \mathbb{R}^6$ is the
\textit{gravity vector}.
Finally, $\vect{u}_i\in\mathbb{R}^6$ is the control input vector representing
the $6$D generalized \textit{actuation force} acting on the agent.

%Let us also define the vectors
%$\vect{X} = [\vect{x}_1^\top, \dots, x_N^\top]^\top :
%\mathbb{R}_{\geq 0} \to \mathbb{M}^N, \vect{V} = [\vect{v}_1^\top, \dots
%\vect{v}_N^\top]^\top: \mathbb{R}_{\geq 0} \to \mathbb{R}^{6N}$.


\begin{bw_box}
  \begin{remark}
    According to \cite{Murray:1994:MIR:561828}, the matrices
    $\dot{\mat{M}}_i - 2\mat{C}_i, i \in \mathcal{V}$ are skew-symmetric.
    The quadratic form of a skew-symmetric matrix is always equal to 0, hence:

    \begin{equation}
      \vect{y}^\top \left[\dot{\mat{M}}_i - 2 \mat{C}_i\right]\vect{y} = 0,
        \forall \vect{y} \in \mathbb{R}^6, i \in \mathcal{V}.
    \label{eq:skew_symm}
    \end{equation}
  \end{remark}
\end{bw_box}

However, access to measurements of, or knowledge about these matrices and
vectors was not considered up until now. At this point we make the following
assumption:

\begin{gg_box}
  \begin{assumption} (\textit{Measurements and Access to Information Assumption From an
    Inter-agent Perspective})
  \begin{enumerate}

    \item Agent $i$ has access to measurements
      $\vect{p}_i, \vect{q}_i, \dot{\vect{p}}_i, \vect{\omega}_i, i\in\mathcal{V}$,
      that is, vectors $\vect{x}_i, \vect{v}_i$ pertaining to himself,

    \item Agent $i$ has a (upper-bounded) sensing range $d_i$ such that
      $$d_i > \max\{r_i + r_j : \forall i,j \in \mathcal{V}, i \neq j\}$$

    \item the inertia $\mat{M}$ and Coriolis $\mat{C}$ vector fields are
      bounded and unknown

    \item the gravity vectors $\vect{g}$ are bounded and known

  \end{enumerate}
  \label{ass:measurements_access}
\end{assumption}
\end{gg_box}

The consequence of points 1 and 2 is that, by defining the set of
agents $j$ that are within the sensing range of agent $i$ at time $t$ as
$$\mathcal{R}_i(t) \triangleq \{j\in\mathcal{V} : \vect{p}_j(t)\in\mathcal{B}(\vect{p}_i(t), d_i)\}$$
or equivalently
$$\mathcal{R}_i(t) \triangleq \{j\in\mathcal{V} : \| \vect{p}_i(t) - \vect{p}_j(t) \| \leq d_i\}$$
agent $i$ also knows at each time instant $t$ all
$$\vect{p}_{j \triangleright i}(t), \vect{q}_{j \triangleright i}(t),
\dot{\vect{p}}_{j \triangleright i}(t), \vect{\omega}_{j \triangleright i}(t)$$
Therefore, agent $i$ assumes access to all measurements
$$\vect{p}_{j}(t), \vect{q}_{j}(t), \dot{\vect{p}}_j(t),
\vect{\omega}_j(t),\ \forall j\in \mathcal{R}_i(t),t\in\mathbb{R}_{\geq 0}$$
of agent $j$ by virtue of being able to calculate them using knowledge of its own
$\vect{p}_i(t)$, $\vect{q}_i(t)$, $\dot{\vect{p}}_i(t)$, $\vect{\omega}_i(t)$.


In the workspace there are $|\mathcal{L}|$ \textit{static obstacles},
also modeled as spheres, with centers at positions
$\vect{p}_{\ell} \in \mathbb{R}^3$ with radii
$r_{\ell}\in \mathbb{R}$, $\ell \in \mathcal{L} = \{1,\dots,|\mathcal{L}| \}$.
Thus, the obstacles are modeled by spheres
$\mathcal{B}(\vect{p}_{\ell}, r_{\ell})$, $\ell \in \{1,\dots,|\mathcal{L}|\}$.
The geometry of two agents $i$ and $j$ as well as an obstacle
$\ell$ in workspace $W$ is depicted in Fig. \ref{fig:two_agents_one_obstacle}.\\

\begin{figure}[ht!]
	\centering
    \input{figures/03.problem_formulation/two_agents_one_obstacle.tex}
    \caption{Illustration of two agents $i, j \in \mathcal{V}$ and an static
      obstacle $\ell \in \mathcal{L}$ in the workspace; $\{\mathcal{O}\}$ is the inertial
      frame, $\{i\}, \{j\}$ are the frames attached to the agents' center of
      mass, $\vect{p}_i, \vect{p}_j, \vect{p}_{\ell} \in \mathbb{R}^3$ are the
      positions of the center of mass of the agents $i,j$ and the
      obstacle $\ell$ respectively, expressed in frame
      $\{\mathcal{O}\}$. $r_i, r_j, r_{\ell}$ are the radii of the agents $i,j$
      and the obstacle $\ell$ respectively. $d_i, d_j$ with
      $d_i > d_j$ are the agents' sensing ranges.
      In this figure, agents $i$ and $j$ are not neighbours, since the center
      of mass of agent $j$ is not within the sensing range of agent $i$ and vice
      versa: $\vect{p}_j \notin \mathcal{B}(\vect{p}_i(t), d_i)$ and
      $\vect{p}_i \notin \mathcal{B}(\vect{p}_j(t), d_j)$.}
	\label{fig:two_agents_one_obstacle}
\end{figure}

Let us now define the distance between any two agents $i,j$ as
$d_{ij,a}$, that between agent $i$ and obstacle $\ell$ as $d_{i\ell,o}$,
and that between an agent $i$ and the workspace $\mathcal{W}$ boundary as
$d_{i,W}$, with $d_{ij,a}, d_{i\ell,o}, d_{i,W} : \mathbb{R}^3 \to \mathbb{R}_{\geq 0}$:
\begin{subequations}
	\begin{align}
    d_{ij,a}(t) &\triangleq \| \vect{p}_i(t) - \vect{p}_j(t) \|, \\
    d_{i\ell,o}(t) &\triangleq \| \vect{p}_i(t) - \vect{p}_\ell(t) \|, \\
    d_{i,W}(t) &\triangleq \| \vect{p}_W - \vect{p}_i(t) \|
	\end{align}
\end{subequations}
as well as constants
\begin{subequations}
	\begin{align}
    \underline{d}_{ij, a} &\triangleq r_{i} + r_{j}, \\
    \underline{d}_{i\ell, o} &\triangleq r_{i} + r_{\ell}
	\end{align}
\end{subequations}
$\forall i, j \in \mathcal{V}$, $i \neq j$, $\ell \in \mathcal{L}$.
The latter stand for the minimum distance between two \textit{agents}, and the
minimum distance between an \textit{agent} and an \textit{obstacle}
respectively. They arise spatially as physical limitations and will be utilized
as collision-avoidance constraints.\\

As is natural, and reasonable, we define the concept of a \textit{collision-free
configuration} between

\begin{itemize}
  \item any two agents $i,j \in \mathcal{V}$, when $d_{ij,a}(t) > \underline{d}_{ij,a}$
  \item an agent $i \in \mathcal{V}$ and an obstacle $\ell \in \mathcal{L}$,
    when $d_{il,o}(t) > \underline{d}_{il,o}$
  \item an agent $i \in \mathcal{V}$ and the workspace $\mathcal{W}$ boundary,
    when $d_{i,W} < r_W - r_i$
\end{itemize}
for an generic time instant $t$.



\begin{bw_box}
\begin{definition}
Agents $j \in \mathcal{N}_i$ are defined as the \textit{neighbours} of
agent $i$. The set $\mathcal{N}_i$ is a priori defined, and composed of the
indices of agents $j \in \mathcal{V}$ which
\begin{enumerate}
  \item are within the sensing range of agent $i$ at time $t=0$, i.e.
    $j \in \mathcal{R}_i(0)$, and
  \item are \textit{intended} to be kept within the sensing range of agent $i$ at all
    times $t \in \mathbb{R}_{> 0}$
\end{enumerate}
\end{definition}
\end{bw_box}

Therefore, while the composition of the set $\mathcal{R}_i(t)$ evolves and
varies through time in general, the set $\mathcal{N}_i$ \textit{should} remain
invariant over time\footnote{This reason, and the fact that the proposed
control scheme guarantees that $\mathcal{N}_i$ \textit{will} remain invariant
over time is why we do not refer to it as $\mathcal{N}_i(t)$.}.

We assume that at time $t=0$ the graph $\mathcal{G}$ constructed by the edges
connecting neighbouring agents $i \in \mathcal{V}$ is undirected, i.e.
\begin{subequations}
\begin{align}
  d_{ij,a}(0) &< d_i, \forall i \in \mathcal{V}, j \in \mathcal{N}_i \label{eq:initially_connected_0} \\
  d_{ji,a}(0) &< d_j, \forall j \in \mathcal{V}, i \in \mathcal{N}_j \label{eq:initially_connected_1}
\end{align}
\end{subequations}

It is also assumed that, at $t=0$, neighboring agents are in a
\textit{collision-free configuration}, i.e.

\begin{equation}
   d_{ij,a}(0) > \underline{d}_{ij, a},\ \forall i,j \in \mathcal{V}, i \neq j
\label{eq:initially_coll_free}
\end{equation}

Furthermore, it is assumed that, initially, the Jacobians $\mat{J}_i$ are
well-defined $\forall i \in \mathcal{V}$. These four assumptions, which concern
the initial conditions of the problem, are summarized in assumption
\ref{ass:initial_conditions}:

\begin{gg_box}
\begin{assumption}(\textit{Initial Conditions Assumption})\\

  At time $t = 0$

  \begin{enumerate}

    \item the sets $\mathcal{N}_i$ are known for all $i \in \mathcal{V}$
      and\footnote{It is not necessary that
      all agents are assigned a set of agents with whom they should maintain
      connectivity; however, if \textit{all} agents were neighbour-less,
      then the concept of \textit{cooperation} between them would be void,
      since in that case the problem would break down into $|\mathcal{V}|$
      individual problems of smaller significance or interest, while
      weakening the ``multi-agent" perspective as well.}
      $\sum\limits_i |\mathcal{N}_i| > 0$

    \item all agents are in a collision-free configuration:

      $$ d_{ij,a}(0) > \underline{d}_{ij,a},\ \forall i \in \mathcal{V},\ j \in \mathcal{V}\backslash \{i\}$$

    \item neighbouring relations are reciprocal:
      \begin{align}
        \underline{d}_{ij,a} < d_{ij,a}(0) &< d_i,\ \forall j \in \mathcal{N}_i \\
        \underline{d}_{ji,a} < d_{ji,a}(0) &< d_j,\ \forall i \in \mathcal{N}_j
      \end{align}

    \item all agents are in a singularity-free configuration:

      $$ -\frac{\pi}{2} < \theta_i(0) < \frac{\pi}{2},\ \forall i \in \mathcal{V}$$

  \end{enumerate}
  \label{ass:initial_conditions}
\end{assumption}
\end{gg_box}


%-------------------------------------------------------------------------------
%\subsection{Objectives}

%The desired steady-state configuration for all agents
%$\vect{x}_{ij,des}$ $=$ $[\vect{p}_{ij,des}^{\top}, \vect{q}_{ij,des}^{\top}]^{\top}$
%are themselves \textit{feasible} if $\forall i \in \mathcal{V}$,
%$j \in \mathcal{N}_i$,
%$$\bigcap \{(\vect{x}_i, \vect{x}_j) \in W^{N_i + 1} : \| \vect{x}_i - \vect{x}_j - \vect{x}_{ij,des} \| = 0 \}
%\ne \varnothing$$
%At this point, let us define $d_o$
%\begin{align*}
  %d_o &\triangleq \min\{\| \vect{p}_{\ell} - \vect{p}_{\ell'}\| : \ell,\ell' \in \mathcal{L}, \ell \neq \ell' \},
%\end{align*}
%as the distance between the two least distant obstacles in the workspace,
%$d_{o,W}$
%\begin{align*}
  %d_{o,W} & \triangleq \min\{r_W - \left( r_{\ell} + \| \vect{p}_{\ell} \| \right) : \ell \in \mathcal{K}\},
%\end{align*}
%as the distance between the least distant obstacle from the boundary of the
%workspace and the boundary itself, $D$
%\begin{equation*}
  %D \triangleq \min\{d_o, d_{o,W}\}
%\end{equation*}
%as the least of these two distances, and $\Delta$
%\begin{align*}
  %\hspace{-2mm} \Delta \triangleq \max\Big\{&d_{ij, a}+r_i+r_j: i, j \in \mathcal{V}, i \neq j, \notag \\
  %&\hspace{-2mm} \| \vect{p}_k - \vect{p}_\ell \| = \vect{p}_{k \ell,\text{des}}, \\
  %&\|\vect{q}_k - \vect{q}_\ell\| = \vect{q}_{k \ell,\text{des}}, \\
  %&k \in \mathcal{V}, \ell \in \mathcal{N}_k\Big\}
%\end{align*}
%as the \emph{diameter of formation}. $\Delta$ is the distance between the two
%most distant agents when formation is achieved. Given these notions, we
%can state an assumption on the feasibility of a solution to the problem
%that this thesis addresses:

%\begin{gg_box}
%\begin{assumption}(After-formation Geometric Assumption)

	%\begin{itemize}
		%\item When the multi-agent system reaches the desired formation, it should
      %be able to pass between two of the obstacles and between an
      %obstacle and the boundary of the workspace.
      %Thus, it is required that $D > \Delta$.
		%\item As a consequence, at the very least, all agents should be able to
      %pass between any two obstacles and between all obstacles and the
      %boundary of the workspace, without, simultaneously, any of them
      %colliding with each other or with the obstacles or the boundary of the
      %workspace.
      %Thus, it is required that $D >  \sum_{i \in \mathcal{V}}^{} 2r_i$.
	%\end{itemize}

	%These geometric assumptions can be summarized in the following
  %inequality:

	%\begin{equation}
    %D > \max\left\{\Delta, \sum_{i \in \mathcal{V}}^{} 2r_i \right\}
  %\label{eq:geometric_constraint}
	%\end{equation}

%\label{ass:after_formation_geometry}
%\end{assumption}
%\end{gg_box}
